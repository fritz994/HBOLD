<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-iconic-font/2.2.0/css/material-design-iconic-font.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.16/css/dataTables.bootstrap4.min.css"/>
{% block additional_css %}
<link rel="stylesheet" type="text/css" href="../css/sshier.css">

{% end %}
<style>
div {
  display: table;
  margin-right: auto;
  margin-left: auto;
}
body{
  padding-top: 70px;
  text-align:center;
  width: 100%;
    height: 100%;
}
</style>
<body>
  <nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <ul class="nav navbar-nav" id="myTab" role="tablist">
            <!-- <form class="form-inline my-2 my-lg-0">
                <div id="myNav" class="overlay" style>
                    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
                    <div class="overlay-content">
                        <a href="/hbold/about">About</a>
                        <a href="/hbold/insertDataset">Dataset Insertion</a>
                    </div>
                </div>
            </form> -->
            <div id="main">
                <span style="font-size:30px;cursor:pointer" onclick="openNav()" class="btn3 fa fa-bars" role="button"></span>
            </div>
            <li class="nav-item">
                <a class="navbar-brand nav-link" id="dataset-tab" data-toggle="tab" href="#dataset" role="tab" aria-controls="home"
                    aria-selected="false">H-Bold
                <span class="sr-only">(current)</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="navbar-brand nav-link" id="graph-tab" data-toggle="tab" href="#graph" role="tab" aria-controls="profile" aria-selected="false">Cluster Schema</a>
            </li>
            <li class="nav-item">
              <a class="navbar-brand nav-link active" id="treemapCS" data-toggle="tab" href="#hierical" role="tab" aria-controls="profile"
              aria-selected="false">TreeMap
          <span class="sr-only">(current)</span>
          </a>
          </li>
            
            <!--
                <li class="nav-item">
                    <a class="navbar-brand nav-link" id="query-tab" data-toggle="tab" href="#query" role="tab" aria-controls="contact" aria-selected="false">Query Panel</a>
                </li>
                -->
        </ul>
    </div>
</nav>


  <!--<div class="tab-pane fade" id="query" role="tabpanel" aria-labelledby="query-tab">...</div>-->
</div>
<div>
<svg width="1300" height="800"></svg>
<form>
  <label><input type="radio" name="mode" value="sumBySize" checked> Size</label>
  <label><input type="radio" name="mode" value="sumByCount"> Count</label>
</form>
</div>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script type="text/javascript" src="../js/jquery.min.js"></script>
<script>
var svg = d3.select("svg"),
    width = +svg.attr("width"),
    height = +svg.attr("height");
var fader = function(color) { return d3.interpolateRgb(color, "#fff")(0.2); },
    color = d3.scaleOrdinal(d3.schemeCategory20.map(fader)),
    format = d3.format(",d");
var treemap = d3.treemap()
    .tile(d3.treemapResquarify)
    .size([width, height])
    .round(true)
    .paddingInner(1);
    var csid = window.location.href.split('/').pop();

    $.ajax({
	type: 'GET',
	url: '../getDataCS/' + csid,
	dataType: 'json',
	success: function(data) {
  
  var flag=change(data);
  //prova.children.forEach(function(d){
   // d.value=10;
    //d.children.forEach(function(p){
  //    p.value=20;
  //  });
  //});
  //if (error) throw error;
 console.log(flag);
  var root = d3.hierarchy(flag)
      .eachBefore(function(d) { d.data.id = (d.parent ? d.parent.data.id + "." : "") + d.data.name; })
      .sum(sumBySize)
      .sort(function(a, b) { return b.height - a.height || b.value - a.value; });
  treemap(root);
  
  var cell = svg.selectAll("g")
    .data(root.leaves())
    .enter().append("g")
      .attr("transform", function(d) { return "translate(" + d.x0 + "," + d.y0 + ")"; });

  cell.append("rect")
      .attr("id", function(d) { return d.data.id; })
      .attr("width", function(d) { return d.x1 - d.x0; })
      .attr("height", function(d) { return d.y1 - d.y0; })
      .attr("fill", function(d) { return color(d.parent.data.vocab); });

  cell.append("clipPath")
      .attr("id", function(d) { return "clip-" + d.data.id; })
    .append("use")
      .attr("xlink:href", function(d) { return "#" + d.data.id; });

  cell.append("text")
      .attr("clip-path", function(d) { return "url(#clip-" + d.data.id + ")"; })
    .selectAll("tspan")
      .data(function(d) { return d.data.name.split(/(?=[A-Z][^A-Z][#][_])/g); })
    .enter().append("tspan")
      .attr("x", 4)
      .attr("y", function(d, i) { return 13 + i * 10; })

      .text(function(d) { return d; });
      
      

  cell.append("title")
      .text(function(d) { return d.data.id + "\n" + format(d.value); });

  d3.selectAll("input")
      .data([sumBySize, sumByCount], function(d) { return d ? d.name : this.value; })
       .on("change", changed);

  var timeout = d3.timeout(function() {
    d3.select("input[value=\"sumByCount\"]")
        .property("checked", true)
        .dispatch("change");
  }, 2000);

  function changed(sum) {
    timeout.stop();
    treemap(root.sum(sum));
    cell.transition()
        .duration(750)
        .attr("transform", function(d) { return "translate(" + d.x0 + "," + d.y0 + ")"; })
      .select("rect")
        .attr("width", function(d) { return d.x1 - d.x0; })
        .attr("height", function(d) { return d.y1 - d.y0; });
  }
}});
    
function sumByCount(d) {
  return d.children ? 0 : 1;
}
function sumBySize(d) {
  return d.size;
}




function change(data){
 
  var children=[]; 
  var nephew=[];
  //var flag={'name':[],'children':[]};
  for(var i=0; i<data.nodes.length;i++){
    nephew[i]=[];
    for(var j=0;j<data.nodes[i].nodes.length;j++){
      nephew[i][j]={'name':data.nodes[i].nodes[j].name,
      'size':data.nodes[i].nodes[j].ni,
      'vocab':data.nodes[i].nodes[j].vocab,
      'id':"root."+data.nodes[i].name+"."+data.nodes[i].nodes[j].name};
    }
    
    children[i]=data.nodes[i];
    console.log(nephew[i]);
  }
  
  // 
console.log(nephew);
  var flag={
    'name': "root",
    'children': []  
  }
  
  for(var j=0;j<data.nodes.length;j++){
    var child={
    'name':"",
    'vocab':getRandomColor(),
    'children':[],
    'id':""
  }
  console.log(Object.keys(children).length);
    child['name']=data.nodes[j].name;
    child['id']=data.nodes[j].name;
    child['children']=nephew[j];   
  
  flag.children.push(child);
  
  }
  
  console.log(nephew);
  console.log(flag);

return flag;
  


}
function getRandomColor() {
  var letters = '0123456789ABCDEF';
  var color = '#';
  for (var i = 0; i < 6; i++) {
    color += letters[Math.floor(Math.random() * 16)];
  }
  return color;
}
$("#dataset-tab").click(function() {
  window.location.href = "../";
 
});
$("#graph-tab").click(function() {
  window.location.href = "../cs/"+csid;
  
});
function openNav() {
  document.getElementById("myNav").style.width = "100%";
}

function closeNav() {
  document.getElementById("myNav").style.width = "0%";
}

</script>